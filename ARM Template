{
    "$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion":"1.0.0.0",
    "parameters":{
       "CountNumber":{
          "defaultValue":[
             "001"
          ],
          "type":"String"
       },
       "quantity":{
          "defaultValue":"1",
          "type":"String"
       },
       "BusinessUnit":{
          "type":"string",
          "defaultValue":"Centrica"
       },
       "diskmounts":{
          "defaultValue":"lun0:opt,lun1:var",
          "type":"String"
       },
       "subscriptionId":{
          "defaultValue":"e18bf182-61b7-4f76-9bb2-384654d0646d",
          "type":"String"
       },
       "stndStorageAccountName":{
          "defaultValue":"azsudiagsha410",
          "type":"String"
       },
       "vmName":{
          "defaultValue":"azsu-d-sha-410",
          "type":"String"
       },
       "vmSize":{
          "defaultValue":"Standard_D2s_v3",
          "type":"String"
       },
       "vmNic1Name":{
          "defaultValue":"nic1",
          "type":"String"
       },
       "vmAdminUsername":{
          "defaultValue":"azureuser",
          "type":"String"
       },
       "vmAdminPublicKey":{
          "defaultValue":"ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDtPH4HjQG5AvBr9U3F/qkeDth2N8Wi3it+3K7qZeh/L6lH2WJ26ZY5m/Yco+H/axbiZyZRU/hKU9P5aLUODKAb3dkQWRP7imhqQn/kmnExYwRCfwigiwbfnYDY85B07z3bSgKIu7HV+74yPUwh61RKCOToSLEcdGr8ROGHP9fprwLtLHngU0glgoaH6GR0GcdrwTQsjM4CCfmmUWxENx2H4s/tX8b3pE5IVdsspzaY0D8ZnCfuwV7sk6Cx/HchkYgs28qC/PxGl4TnWNiZhb3Wi+WOLvxrLHcxbWxzhy4vj0tbauJ/pCDZPJnIOO9jPnylr54rh+TvVobztCChXC55",
          "type":"String"
       },
       "vnetName":{
          "defaultValue":"azsu-vnet-devtest-m-200",
          "type":"String"
       },
       "vnetRG":{
          "defaultValue":"azsu-rg-devtest-defaultnetworking-001",
          "type":"String"
       },
       "subnet1Name":{
          "defaultValue":"azsu-subn-devtest-m-cogtest-001",
          "type":"String"
       },
       "ASName":{
          "defaultValue":"azsu-d-avset-sha-410",
          "type":"String"
       },
       "faultDomain":{
          "defaultValue":2,
          "type":"Int"
       },
       "updateDomain":{
          "defaultValue":2,
          "type":"Int"
       },
       "bootstrapScriptName":{
          "defaultValue":"bootstrap-azure-RHEL-instances_v1-2.sh",
          "type":"String"
       },
       "dataDisks":{
          "defaultValue":[
             {
                "caching":"ReadOnly",
                "createOption":"Empty",
                "diskSizeGB":"32",
                "lun":"0",
                "managedDisk":{
                   "storageAccountType":"Standard_LRS"
                }
             }
          ],
          "type":"String"
       },
       "tagValues":{
          "defaultValue":{
             "Cost code ID":"[resourceGroup().tags['Cost code ID']]"
          },
          "type":"String"
       },
       "tagValuesVM":{
          "defaultValue":{
             "Cost code ID":"[resourceGroup().tags['Cost code ID']]"
          },
          "type":"String"
       },
       "selectedenvironment":{
          "defaultValue":"core",
          "type":"String"
       },
       "pprole":{
          "defaultValue":"undefined",
          "type":"String"
       },
       "selectedregion":{
          "defaultValue":"uksouth",
          "type":"String"
       },
       "sourceImage":{
          "defaultValue":"MarketPlace",
          "allowedValues":[
             "MarketPlace",
             "BYOS",
             "CustomImage"
          ],
          "type":"String",
          "metadata":{
             "description":"Select the source image"
          }
       },
       "imagePublisherP":{
          "defaultValue":"RedHat",
          "type":"String"
       },
       "imageOfferP":{
          "defaultValue":"RHEL",
          "type":"String"
       },
       "imageSKUP":{
          "defaultValue":"7.3",
          "type":"String"
       },
       "ByosPlanName":{
          "defaultValue":"rhel-lvm74",
          "type":"String"
       },
       "plan":{
        "defaultValue":"",
          "type":"String"
       },
       "storageAccType":{
          "defaultValue":"Standard_LRS",
          "type":"String"
       },
       "storageAccTier":{
          "defaultValue":"Standard",
          "type":"String"
       }
    },
    "variables":{
       "storageAccType":"[parameters('storageAccType')]",
       "storageAccTier":"[parameters('storageAccTier')]",
       "location":"[resourceGroup().location]",
       "rgName":"[resourceGroup().name]",
       "stndStorageAccountName":"[parameters('stndStorageAccountName')]",
       "commandDE":"curl -k --data \"host_config_key=dc375f87-0171-47fb-90cd-36a2a6f1206d\" https://10.157.28.186:443/api/v2/job_templates/14/callback/",
       "commandCentrica":"[concat('curl -u 008eca51d2e117bbe2bd195d09be1a075134ad20:x-oauth-basic -H \"Accept: application/vnd.github.VERSION.raw\" \"https://github.aws.uk.centricaplc.com/api/v3/repos/Operations/Scripts/contents/AzureProvisioning/v2.ARM/5.Compute/generic/Linux/',parameters('bootstrapScriptName'),'?refs=master\" > /root/bootstrap-azure-linux-instances.sh',' && chmod 755 /root/bootstrap-azure-linux-instances.sh && sh /root/bootstrap-azure-linux-instances.sh ',parameters('selectedenvironment'),' ',parameters('pprole'),' ',parameters('selectedregion'),' ',parameters('diskmounts'),' ',parameters('imageOfferP'),' && exit 0')]",
       "tagValues":"[parameters('tagValues')]",
       "tagValuesVM":"[parameters('tagValuesVM')]",
       "vmName":"[parameters('vmName')]",
       "vmSize":"[parameters('vmSize')]",
       "vmNic1Name":"[concat(parameters('vmName'), '-' ,parameters('vmNic1Name'))]",
       "vmAdminUsername":"[parameters('vmAdminUsername')]",
       "vmAdminPublicKey":"[parameters('vmAdminPublicKey')]",
       "vnetName":"[toLower(parameters('vnetName'))]",
       "vnetResourceId":"[concat('/subscriptions/', parameters('subscriptionId'), '/resourcegroups/', parameters('vnetRG'), '/providers/Microsoft.Network/virtualNetworks/', parameters('vnetName'))]",
       "subnet1Name":"[parameters('subnet1Name')]",
       "templateBaseURL":"https://bgcoreamsterdam.blob.core.windows.net/scripts/",
       "templateBootstrapURL":"https://bgcoreamsterdam.blob.core.windows.net/scripts/",
       "bootstrapScriptName":"[parameters('bootstrapScriptName')]",
       "bootstrapScriptLink":"[concat(variables('templateBootstrapURL'), variables('bootstrapScriptName'))]",
       "osDiskName":"osdisk",
       "imagePublisher":"[parameters('imagePublisherP')]",
       "imageOffer":"[parameters('imageOfferP')]",
       "imageSKU":"[parameters('imageSKUP')]",
       "ASName":"[parameters('ASName')]",
       "faultDomain":"[parameters('faultDomain')]",
       "updateDomain":"[parameters('updateDomain')]",
       "CountNumberArr":"[array(parameters('CountNumber'))]",
       "datadisksArr": "[json(parameters('datadisks'))]",
       "tagValuesObj":"[json(parameters('tagValues'))]",
       "tagValuesVMObj":"[json(parameters('tagValuesVM'))]",
       "planObj":"[json(parameters('plan'))]"
    },
    "resources":[

     {
        "type":"Microsoft.Storage/storageAccounts",
        "sku":{
           "name":"Standard_LRS"
        },
        "kind":"Storage",
        "name":"[variables('stndStorageAccountName')]",
        "apiVersion":"2017-06-01",
        "location":"[resourceGroup().location]",
        "tags":"[variables('tagValuesObj')]"
     },
     {
        "type":"Microsoft.Compute/availabilitySets",
        "sku":{
           "name":"Aligned"
        },
        "name":"[variables('ASName')]",
        "apiVersion":"2017-03-30",
        "location":"[variables('location')]",
        "tags":"[variables('tagValuesObj')]",
        "properties":{
           "platformFaultDomainCount":"[variables('faultDomain')]",
           "platformUpdateDomainCount":"[variables('updateDomain')]"
        }
     },
     {
        "type":"Microsoft.Compute/virtualMachines",
        "name":"[concat(variables('vmName'))]",
        "apiVersion":"2018-06-01",
        "location":"[variables('location')]",
        "copy":{
           "name":"networkInterfacesVM",
           "count":"[length(variables('CountNumberArr'))]"
        },
        "tags":"[variables('tagValuesVMObj')]",
        "properties":{
           "availabilitySet":{
              "id":"[resourceId('Microsoft.Compute/availabilitySets', variables('ASName'))]"
           },
           "osProfile":{
              "computerName":"[concat(variables('vmName'))]",
              "adminUsername":"[variables('vmAdminUsername')]",
              "linuxConfiguration":{
                 "disablePasswordAuthentication":"true",
                 "ssh":{
                    "publicKeys":[
                       {
                          "path":"[concat('/home/', variables('vmAdminUsername'), '/.ssh/authorized_keys')]",
                          "keyData":"[variables('vmAdminPublicKey')]"
                       }
                    ]
                 }
              }
           },
           "hardwareProfile":{
              "vmSize":"[variables('vmSize')]"
           },
           "storageProfile":{
              "imageReference":{
                 "publisher":"[variables('imagePublisher')]",
                 "offer":"[if(equals(parameters('sourceImage'),'MarketPlace'),variables('imageOffer'),'rhel-byos')]",
                 "sku":"[if(equals(parameters('sourceImage'),'MarketPlace'),variables('imageSKU'),parameters('ByosPlanName'))]",
                 "version":"latest"
              },
              "osDisk":{
                 "createOption":"FromImage",
                 "osType":"Linux",
                 "diskSizeGB":"[if(equals(parameters('BusinessUnit'),'DE'),'50', json('null'))]",
                 "managedDisk":{
                    "storageAccountType":"[variables('storageAccType')]"
                 }
              },
              "dataDisks":"[if(equals(parameters('BusinessUnit'),'Centrica'),variables('dataDisksArr'), json('null'))]"
           },
           "diagnosticsProfile":{
              "bootDiagnostics":{
                 "enabled":true,
                 "storageUri":"[concat(reference(concat('Microsoft.Storage/storageAccounts/', variables('stndStorageAccountName')), '2016-01-01').primaryEndpoints.blob)]"
              }
           },
           "networkProfile":{
              "networkInterfaces":[
                 {
                    "properties":{
                       "primary":true
                    },
                    "id":"[resourceId('Microsoft.Network/networkInterfaces', concat(variables('vmName'),'-',parameters('vmNic1Name')))]"
                 }
              ]
           }
        },
        "plan":"[if(equals(parameters('sourceImage'),'BYOS'),variables('planObj'),json('null'))]",
        "dependsOn":[
           "[resourceId('Microsoft.Storage/storageAccounts/', variables('stndStorageAccountName'))]",
           "[concat('Microsoft.Network/networkInterfaces/',variables('vmName'),'-',parameters('vmNic1Name'))]",
           "[resourceId('Microsoft.Compute/AvailabilitySets/', variables('ASName'))]"
        ]
     },
     {
        "type":"Microsoft.Network/networkInterfaces",
        "name":"[concat(variables('vmName'),'-',parameters('vmNic1Name'))]",
        "apiVersion":"2016-03-30",
        "location":"[variables('location')]",
        "copy":{
           "name":"networkInterfacesVM",
           "count":"[length(variables('CountNumberArr'))]"
        },
        "tags":"[variables('tagValuesObj')]",
        "properties":{
           "primary":true,
           "ipConfigurations":[
              {
                 "name":"[concat(variables('vmName'),'-ipconfig')]",
                 "properties":{
                    "privateIPAllocationMethod":"Dynamic",
                    "subnet":{
                       "id":"[toLower(concat(variables('vnetResourceId'), '/subnets/', variables('subnet1Name')))]"
                    }
                 }
              }
           ],
           "enableIPForwarding":false
        }
     },
     {
        "type":"Microsoft.Compute/virtualMachines/extensions",
        "name":"[concat(variables('vmName'),'/Bootstrap')]",
        "apiVersion":"2015-06-15",
        "location":"[variables('location')]",
        "copy":{
           "name":"networkInterfacesVM",
           "count":"[length(variables('CountNumberArr'))]"
        },
        "tags":"[variables('tagValuesObj')]",
        "properties":{
           "publisher":"Microsoft.Azure.Extensions",
           "type":"CustomScript",
           "typeHandlerVersion":"2.0",
           "autoUpgradeMinorVersion":true,
           "settings":{
              "commandToExecute":"[if(equals(parameters('BusinessUnit'),'Centrica'),variables('commandCentrica'), variables('commandDE'))]"
           }
        },
        "dependsOn":[
           "[concat('Microsoft.Compute/virtualMachines/', variables('vmName'))]"
        ]
     }
  ]
 }
